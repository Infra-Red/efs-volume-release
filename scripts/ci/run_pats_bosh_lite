#!/bin/bash
# vim: set ft=sh

set -e -x

scripts_path=./$(dirname $0)/..
eval $($scripts_path/get_paths.sh)

bbl --state-dir bbl-state/${BBL_STATE_DIR} print-env > set-env.sh
source set-env.sh

export CF_API_ENDPOINT=api.${BOSH_ENVIRONMENT}.sslip.io
export APPS_DOMAIN=${BOSH_ENVIRONMENT}.sslip.io
export BROKER_URL=http://efs-broker.${BOSH_ENVIRONMENT}.sslip.io

# CF_PASSWORD and BROKER_PASSWORD can either be passed in as environment variables, or extracted from a deployment-vars file
# in environments where they are dynamically generated by BOSH
if [ -z "$CF_PASSWORD" ]; then
    bosh_manifest_password_variable_name=cf_admin_password
    CF_PASSWORD=`credhub find -j -n ${bosh_manifest_password_variable_name} | jq -r .credentials[].name | xargs credhub get -j -n | jq -r .value`
fi

if [ -z "$BROKER_PASSWORD" ]; then
    bosh_manifest_password_variable_name=$BROKER_PASSWORD_KEY
    BROKER_PASSWORD=`credhub find -j -n ${bosh_manifest_password_variable_name} | jq -r .credentials[].name | xargs credhub get -j -n | jq -r .value`
fi

${scripts_path}/ci/run_pats_withsetup
